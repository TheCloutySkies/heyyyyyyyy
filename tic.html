import React, { useState, useEffect, useCallback } from 'react';
import { createRoot } from 'react-dom/client';

// --- Constants & Assets ---
const ASSETS = {
  X: 'Sign006_result.png',
  O: 'Net003_result.png',
  AVATAR: 'nerdy skies.jpg',
  STAR_1: 'sign026_result.png',
  STAR_2: 'sign027_result.png'
};

const WIN_COMBOS = [
  [0, 1, 2], [3, 4, 5], [6, 7, 8],
  [0, 3, 6], [1, 4, 7], [2, 5, 8],
  [0, 4, 8], [2, 4, 6]
];

// --- Minimax Logic (Pure Functions) ---
function checkWinner(board: string[]) {
  for (let combo of WIN_COMBOS) {
    if (board[combo[0]] && 
        board[combo[0]] === board[combo[1]] && 
        board[combo[0]] === board[combo[2]]) {
      return board[combo[0]];
    }
  }
  if (!board.includes('')) return 'draw';
  return null;
}

function minmax(board: string[], depth: number, isMaximizing: boolean): number {
  const result = checkWinner(board);
  if (result === 'O') return 10 - depth;
  if (result === 'X') return depth - 10;
  if (result === 'draw') return 0;

  if (isMaximizing) {
    let bestScore = -Infinity;
    for (let i = 0; i < board.length; i++) {
      if (board[i] === '') {
        board[i] = 'O';
        let score = minmax(board, depth + 1, false);
        board[i] = '';
        bestScore = Math.max(score, bestScore);
      }
    }
    return bestScore;
  } else {
    let bestScore = Infinity;
    for (let i = 0; i < board.length; i++) {
      if (board[i] === '') {
        board[i] = 'X';
        let score = minmax(board, depth + 1, true);
        board[i] = '';
        bestScore = Math.min(score, bestScore);
      }
    }
    return bestScore;
  }
}

function getBestMove(board: string[]) {
  // Create a copy to simulate moves
  const tempBoard = [...board];
  let bestScore = -Infinity;
  let moves: number[] = [];

  for (let i = 0; i < tempBoard.length; i++) {
    if (tempBoard[i] === '') {
      tempBoard[i] = 'O';
      let score = minmax(tempBoard, 0, false);
      tempBoard[i] = '';
      
      if (score > bestScore) {
        bestScore = score;
        moves = [i];
      } else if (score === bestScore) {
        moves.push(i);
      }
    }
  }
  // Add randomness among equal best moves to feel less robotic
  return moves[Math.floor(Math.random() * moves.length)];
}

// --- Components ---

const BackButton = () => (
  <a href="index.html" style={{
    position: 'fixed',
    top: '24px',
    left: '24px',
    padding: '12px 24px',
    background: 'rgba(255, 255, 255, 0.03)',
    color: '#e0e5ef',
    border: '1px solid rgba(255, 255, 255, 0.1)',
    borderRadius: '12px',
    textDecoration: 'none',
    fontWeight: 600,
    fontSize: '14px',
    letterSpacing: '0.5px',
    backdropFilter: 'blur(12px)',
    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
    zIndex: 20
  }}
  onMouseEnter={(e) => {
    e.currentTarget.style.background = 'rgba(69, 128, 196, 0.2)';
    e.currentTarget.style.transform = 'translateY(-2px)';
    e.currentTarget.style.borderColor = 'rgba(69, 128, 196, 0.4)';
    e.currentTarget.style.boxShadow = '0 8px 16px rgba(69, 128, 196, 0.2)';
  }}
  onMouseLeave={(e) => {
    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)';
    e.currentTarget.style.transform = 'translateY(0)';
    e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    e.currentTarget.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
  }}
  >
    ‚Üê Return Home
  </a>
);

const FloatingStars = () => {
  const [stars, setStars] = useState<Array<{id: number, src: string, style: React.CSSProperties}>>([]);

  useEffect(() => {
    const starCount = 15;
    const newStars = Array.from({ length: starCount }).map((_, i) => {
      const duration = 15 + Math.random() * 25;
      const delay = Math.random() * -20;
      const floatX = (Math.random() - 0.5) * 300;
      const floatY = (Math.random() - 0.5) * 300;
      
      return {
        id: i,
        src: Math.random() > 0.5 ? ASSETS.STAR_1 : ASSETS.STAR_2,
        style: {
          position: 'fixed' as const,
          left: `${Math.random() * 100}vw`,
          top: `${Math.random() * 100}vh`,
          width: '24px',
          height: '24px',
          opacity: 0.4,
          pointerEvents: 'none' as const,
          zIndex: 0,
          filter: 'drop-shadow(0 0 8px rgba(255, 255, 255, 0.5))',
          animation: `float ${duration}s infinite linear ${delay}s`,
          ['--float-x' as any]: `${floatX}px`,
          ['--float-y' as any]: `${floatY}px`,
        }
      };
    });
    setStars(newStars);
  }, []);

  return (
    <>
      <style>{`
        @keyframes float {
          0% { transform: translate(0, 0) rotate(0deg); }
          50% { transform: translate(var(--float-x), var(--float-y)) rotate(180deg); }
          100% { transform: translate(0, 0) rotate(360deg); }
        }
      `}</style>
      {stars.map(star => (
        <div key={star.id} style={star.style}>
          <img src={star.src} alt="" style={{ width: '100%', height: '100%', objectFit: 'contain' }} />
        </div>
      ))}
    </>
  );
};

const Avatar = ({ isThinking }: { isThinking: boolean }) => (
  <>
    {/* Speech Bubble */}
    <div style={{
      position: 'fixed',
      right: '160px',
      bottom: '120px',
      background: 'rgba(20, 24, 33, 0.9)',
      padding: '12px 20px',
      borderRadius: '16px',
      border: '1px solid rgba(69, 128, 196, 0.4)',
      boxShadow: '0 8px 24px rgba(0, 0, 0, 0.4)',
      color: '#e0e5ef',
      fontSize: '14px',
      fontWeight: 500,
      opacity: isThinking ? 1 : 0,
      transform: isThinking ? 'translateY(0) scale(1)' : 'translateY(15px) scale(0.9)',
      transition: 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)',
      pointerEvents: 'none',
      zIndex: 10
    }}>
      Thinking...
      <div style={{
        position: 'absolute',
        right: '-8px',
        bottom: '15px',
        width: 0,
        height: 0,
        borderLeft: '8px solid rgba(20, 24, 33, 0.9)',
        borderTop: '8px solid transparent',
        borderBottom: '8px solid transparent'
      }} />
    </div>
    
    {/* Avatar Image */}
    <div style={{
      position: 'fixed',
      right: '25px',
      bottom: '25px',
      width: '110px',
      height: '110px',
      borderRadius: '50%',
      border: `2px solid ${isThinking ? 'rgba(69, 128, 196, 0.9)' : 'rgba(69, 128, 196, 0.3)'}`,
      boxShadow: isThinking ? '0 0 30px rgba(69, 128, 196, 0.5)' : '0 4px 15px rgba(0, 0, 0, 0.4)',
      background: 'rgba(26, 26, 26, 0.8)',
      padding: '4px',
      zIndex: 10,
      transition: 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
      transform: isThinking ? 'scale(1.1)' : 'scale(1)'
    }}>
      <img 
        src={ASSETS.AVATAR} 
        alt="Clouty Skies" 
        style={{
          width: '100%',
          height: '100%',
          borderRadius: '50%',
          objectFit: 'cover'
        }} 
      />
    </div>
  </>
);

const App = () => {
  const [board, setBoard] = useState<string[]>(Array(9).fill(''));
  const [isXNext, setIsXNext] = useState(true);
  const [winner, setWinner] = useState<string | null>(null);
  const [isThinking, setIsThinking] = useState(false);
  const [statusText, setStatusText] = useState("Your turn (X)");

  // Handle game end state
  useEffect(() => {
    const res = checkWinner(board);
    if (res) {
      setWinner(res);
      if (res === 'X') setStatusText("Victory!");
      else if (res === 'O') setStatusText("Clouty Skies wins!");
      else setStatusText("Draw Game");
    } else {
      setStatusText(isXNext ? "Your turn (X)" : "Opponent Turn...");
    }
  }, [board]);

  // Handle CPU Move
  useEffect(() => {
    if (!isXNext && !winner) {
      setIsThinking(true);
      // Variable delay to make it feel more "human"
      const delay = 800 + Math.random() * 600;
      const timer = setTimeout(() => {
        const move = getBestMove(board);
        if (move !== undefined) {
          setBoard(prev => {
            const newBoard = [...prev];
            newBoard[move] = 'O';
            return newBoard;
          });
          setIsXNext(true);
        }
        setIsThinking(false);
      }, delay);
      return () => clearTimeout(timer);
    }
  }, [isXNext, winner, board]);

  const handleCellClick = (index: number) => {
    // Block interaction if cell occupied, game over, or CPU is thinking
    if (board[index] || winner || !isXNext) return;
    
    const newBoard = [...board];
    newBoard[index] = 'X';
    setBoard(newBoard);
    setIsXNext(false);
  };

  const resetGame = () => {
    setBoard(Array(9).fill(''));
    setIsXNext(true);
    setWinner(null);
    setIsThinking(false);
  };

  return (
    <>
      <BackButton />
      <FloatingStars />
      <Avatar isThinking={isThinking} />
      
      <div style={{
        background: 'rgba(26, 26, 26, 0.5)',
        backdropFilter: 'blur(24px)',
        WebkitBackdropFilter: 'blur(24px)',
        border: '1px solid rgba(255, 255, 255, 0.08)',
        borderRadius: '24px',
        padding: '40px',
        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.05)',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        gap: '25px',
        zIndex: 5,
        maxWidth: '90vw',
        transform: 'translateZ(0)' // GPU acceleration hint
      }}>
        {/* Status Header */}
        <div style={{
          fontSize: '28px',
          fontWeight: 600,
          background: 'linear-gradient(to right, #e0e5ef, #a0a5af)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          textShadow: '0 2px 4px rgba(0, 0, 0, 0.3)',
          minHeight: '42px',
          display: 'flex',
          alignItems: 'center',
          letterSpacing: '-0.5px'
        }}>
          {statusText}
        </div>

        {/* Game Board */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(3, 100px)',
          gap: '12px',
          padding: '12px',
          background: 'rgba(0, 0, 0, 0.2)',
          borderRadius: '16px',
          border: '1px solid rgba(255, 255, 255, 0.03)',
          boxShadow: 'inset 0 2px 4px rgba(0,0,0,0.2)'
        }}>
          {board.map((cell, index) => (
            <div
              key={index}
              onClick={() => handleCellClick(index)}
              style={{
                width: '100px',
                height: '100px',
                background: 'linear-gradient(to bottom, rgba(45, 45, 45, 0.9), rgba(25, 25, 25, 0.95))',
                border: '1px solid rgba(69, 128, 196, 0.2)',
                borderRadius: '12px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: !cell && !winner && isXNext ? 'pointer' : 'default',
                transition: 'all 0.2s ease-out',
                position: 'relative',
                overflow: 'hidden'
              }}
              onMouseEnter={(e) => {
                if (!cell && !winner && isXNext) {
                  e.currentTarget.style.background = 'linear-gradient(to bottom, rgba(69, 128, 196, 0.25), rgba(40, 40, 40, 0.9))';
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.15)';
                  e.currentTarget.style.borderColor = 'rgba(69, 128, 196, 0.5)';
                }
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = 'linear-gradient(to bottom, rgba(45, 45, 45, 0.9), rgba(25, 25, 25, 0.95))';
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = 'none';
                e.currentTarget.style.borderColor = 'rgba(69, 128, 196, 0.2)';
              }}
            >
              {cell && (
                <img 
                  src={cell === 'X' ? ASSETS.X : ASSETS.O} 
                  alt={cell}
                  style={{
                    width: '65%',
                    height: '65%',
                    objectFit: 'contain',
                    filter: cell === 'X' 
                      ? 'drop-shadow(0 0 10px rgba(69, 128, 196, 0.6))' 
                      : 'drop-shadow(0 0 10px rgba(255, 90, 90, 0.5))',
                    animation: 'popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards'
                  }}
                />
              )}
            </div>
          ))}
        </div>

        <style>{`
          @keyframes popIn {
            0% { opacity: 0; transform: scale(0.4) rotate(-10deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
          }
        `}</style>

        {/* Reset Button */}
        <button 
          onClick={resetGame}
          style={{
            marginTop: '15px',
            padding: '14px 40px',
            background: 'linear-gradient(180deg, rgba(60, 65, 75, 0.9) 0%, rgba(30, 32, 40, 0.95) 100%)',
            color: '#e0e5ef',
            border: '1px solid rgba(69, 128, 196, 0.3)',
            borderRadius: '10px',
            fontSize: '16px',
            fontWeight: 600,
            cursor: 'pointer',
            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)',
            textTransform: 'uppercase',
            letterSpacing: '1px',
            width: '100%'
          }}
          onMouseEnter={(e) => {
            e.currentTarget.style.background = 'linear-gradient(180deg, rgba(69, 128, 196, 0.4) 0%, rgba(30, 32, 40, 0.95) 100%)';
            e.currentTarget.style.transform = 'translateY(-2px)';
            e.currentTarget.style.boxShadow = '0 8px 15px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            e.currentTarget.style.borderColor = 'rgba(69, 128, 196, 0.8)';
          }}
          onMouseLeave={(e) => {
            e.currentTarget.style.background = 'linear-gradient(180deg, rgba(60, 65, 75, 0.9) 0%, rgba(30, 32, 40, 0.95) 100%)';
            e.currentTarget.style.transform = 'translateY(0)';
            e.currentTarget.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)';
            e.currentTarget.style.borderColor = 'rgba(69, 128, 196, 0.3)';
          }}
        >
          Reset Game
        </button>
      </div>
    </>
  );
};

const root = createRoot(document.getElementById('root')!);
root.render(<App />);
